name: ğŸš– Mobility Ops 360 CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '18'
  FLUTTER_VERSION: '3.16.0'

jobs:
  # ãƒ†ã‚¹ãƒˆãƒ»å“è³ªãƒã‚§ãƒƒã‚¯
  test:
    name: ğŸ§ª Test & Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ“± Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        cd backend && npm ci
        cd ../frontend/mobi360_app && flutter pub get
        
    - name: ğŸ” Flutter Analysis
      run: cd frontend/mobi360_app && flutter analyze
      
    - name: ğŸ§ª Flutter Tests
      run: cd frontend/mobi360_app && flutter test
      
    - name: ğŸ§ª Backend Tests
      run: cd backend && npm test
      continue-on-error: true
      
    - name: ğŸ”’ Security Audit
      run: cd backend && npm audit --audit-level moderate
      continue-on-error: true
      
    - name: ğŸ“Š Generate Test Report
      if: always()
      run: |
        mkdir -p reports
        echo "# Test Report" > reports/test-results.md
        echo "Generated: $(date)" >> reports/test-results.md
        
    - name: ğŸ“¢ Notify Test Results
      if: always()
      run: |
        STATUS=$([[ ${{ job.status }} == 'success' ]] && echo "success" || echo "error")
        MESSAGE="ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå®Œäº† - Status: ${{ job.status }}"
        echo "Test notification: $MESSAGE"
        # Webhooké€šçŸ¥ã¯å®Ÿè£…äºˆå®š

  # ãƒ“ãƒ«ãƒ‰
  build:
    name: ğŸ”¨ Build
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ“± Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        cd backend && npm ci
        cd ../frontend/mobi360_app && flutter pub get
        
    - name: ğŸ”¨ Build Flutter Web
      run: |
        cd frontend/mobi360_app
        flutter build web --release --dart-define=API_BASE_URL=https://api.mobility360.jp
        
    - name: ğŸ“¦ Archive Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          frontend/mobi360_app/build/web/
          backend/src/
        retention-days: 30
        
    - name: ğŸ“¢ Notify Build Complete
      run: |
        echo "Build completed successfully"
        # Webhooké€šçŸ¥ã¯å®Ÿè£…äºˆå®š

  # ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰
  deploy-production:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: ğŸ“¦ Download Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        
    - name: â˜ï¸ Setup Wrangler
      run: npm install -g wrangler
      
    - name: ğŸš€ Deploy to Cloudflare Workers
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      run: |
        cd backend
        wrangler publish --env production
        
    - name: ğŸŒ Deploy Frontend to Cloudflare Pages
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      run: |
        echo "Frontend deployment placeholder"
        # wrangler pages publish frontend/mobi360_app/build/web --project-name=mobility-ops-360
        
    - name: ğŸ¥ Health Check
      run: |
        sleep 30
        curl -f https://api.mobility360.jp/health || exit 1
        
    - name: ğŸ“¢ Notify Deployment Success
      run: |
        echo "Production deployment completed successfully"
        # Google Chat webhooké€šçŸ¥å®Ÿè£…äºˆå®š
        
    - name: ğŸ“ Create Release Tag
      if: success()
      run: |
        TAG="v$(date +%Y%m%d%H%M%S)"
        git tag $TAG
        git push origin $TAG
        echo "Created release tag: $TAG"

  # ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒï¼‰
  deploy-staging:
    name: ğŸ­ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.ref == 'refs/heads/develop'
    environment: staging
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: ğŸ“¦ Download Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        
    - name: â˜ï¸ Setup Wrangler
      run: npm install -g wrangler
      
    - name: ğŸ­ Deploy to Staging
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      run: |
        cd backend
        wrangler publish --env staging
        
    - name: ğŸ¥ Staging Health Check
      run: |
        sleep 15
        curl -f https://staging-api.mobility360.jp/health || exit 1
        
    - name: ğŸ“¢ Notify Staging Deployment
      run: |
        echo "Staging deployment completed"
        # Google Chat webhooké€šçŸ¥å®Ÿè£…äºˆå®š

  # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–
  performance-monitor:
    name: âš¡ Performance Monitoring
    runs-on: ubuntu-latest
    needs: deploy-production
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“Š Lighthouse CI
      uses: treosh/lighthouse-ci-action@v12
      with:
        urls: |
          https://mobility360.jp
          https://api.mobility360.jp/health
        configPath: './lighthouserc.json'
        uploadArtifacts: true
        temporaryPublicStorage: true
        
    - name: ğŸ“ˆ Performance Report
      run: |
        echo "Performance monitoring completed"
        # çµæœã‚’Google Chatã«é€šçŸ¥äºˆå®š

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ” CodeQL Analysis
      uses: github/codeql-action/init@v3
      with:
        languages: javascript, typescript
        
    - name: ğŸ” Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      
    - name: ğŸ”’ Trivy Security Scan
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: ğŸ“Š Upload Security Results
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: 'trivy-results.sarif'
        
    - name: ğŸ“¢ Security Report Notification
      run: |
        echo "Security scan completed"
        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆã‚’Google Chatã«é€šçŸ¥äºˆå®š