name: Voice System Test

on:
  push:
    paths:
      - 'backend/src/**'
      - 'backend/api/**'
      - '.github/workflows/voice-test.yml'
  schedule:
    - cron: '0 */6 * * *'  # 6ÊôÇÈñì„Åî„Å®„Å´ÂÆüË°å
  workflow_dispatch:  # ÊâãÂãïÂÆüË°å„ÇÇÂèØËÉΩ

jobs:
  voice-webhook-test:
    name: Test Voice Webhooks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Test Voice Incoming Webhook
        run: |
          echo "üé§ Testing voice incoming webhook..."
          
          RESPONSE=$(curl -X POST https://mobility-ops-360-api.yukihamada.workers.dev/api/voice/incoming \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "From=%2B81901234567&To=%2B19592105018&CallSid=CAtest$(date +%s)" \
            -s)
          
          echo "Response:"
          echo "$RESPONSE" | xmllint --format - || echo "$RESPONSE"
          
          # Check if response contains expected TwiML
          if echo "$RESPONSE" | grep -q "<Response>"; then
            echo "‚úÖ Voice incoming webhook test passed"
          else
            echo "‚ùå Voice incoming webhook test failed"
            exit 1
          fi

      - name: Test Speech Processing Webhook
        run: |
          echo "üó£Ô∏è Testing speech processing webhook..."
          
          RESPONSE=$(curl -X POST https://mobility-ops-360-api.yukihamada.workers.dev/api/voice/process-speech \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "SpeechResult=Êù±‰∫¨ÈßÖ„Åã„ÇâÊ∏ãË∞∑ÈßÖ„Åæ„Åß&Confidence=0.95&CallSid=CAtest$(date +%s)" \
            -s)
          
          echo "Response:"
          echo "$RESPONSE" | xmllint --format - || echo "$RESPONSE"
          
          # Check if response contains the location
          if echo "$RESPONSE" | grep -q "Êù±‰∫¨ÈßÖ„Åã„ÇâÊ∏ãË∞∑ÈßÖ„Åæ„Åß"; then
            echo "‚úÖ Speech processing webhook test passed"
          else
            echo "‚ùå Speech processing webhook test failed"
            exit 1
          fi

      - name: Test Status Callback
        run: |
          echo "üìä Testing status callback webhook..."
          
          HTTP_CODE=$(curl -X POST https://mobility-ops-360-api.yukihamada.workers.dev/api/twilio/status \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "CallSid=CAtest$(date +%s)&CallStatus=completed&From=%2B81901234567&To=%2B19592105018" \
            -s -o /dev/null -w "%{http_code}")
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Status callback test passed (HTTP $HTTP_CODE)"
          else
            echo "‚ùå Status callback test failed (HTTP $HTTP_CODE)"
            exit 1
          fi

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issue = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® Voice System Test Failed',
              body: `Voice webhook tests failed at ${new Date().toISOString()}
              
              Please check:
              - Twilio webhook configuration
              - API deployment status
              - Voice endpoint functionality
              
              [View workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
            };
            github.rest.issues.create(issue);